
<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Add Patient</title><link rel="stylesheet" href="style.css"></head><body>
<header><h1>J N HOMEOPATHY CLINIC â€” Add / Edit Patient</h1></header>
<main class="container">
  <a class="link" href="index.html">â¬… Back to Menu</a>
  <form id="patientForm">
    <h2>1. Preliminary Data</h2>
    <div class="field-row">
      <div><label>Date</label><input type="date" id="date" required></div>
      <div><label>Case No</label><input type="text" id="caseNo" required></div>
    </div>
    <div class="field-row">
      <div><label>Phone Number</label><input type="tel" id="phone"></div>
      <div><label>Name</label><input type="text" id="name" required></div>
    </div>
    <div class="field-row">
      <div><label>Age</label><input type="number" id="age"></div>
      <div><label>Gender</label><select id="gender"><option value=""></option><option>Male</option><option>Female</option><option>Other</option></select></div>
    </div>
    <label>Occupation</label><input id="occupation" type="text">
    <label>Address</label><input id="address" type="text">
    <label>Fee (â‚¹)</label><input id="fee" type="number">

    <h2>2. Patient Symptoms</h2>
    <label>Chief Complaints</label><textarea id="chief" rows="4"></textarea>

    <table class="table">
      <thead><tr><th>PATIENT LANGUAGE / PHYSICIAN OBSERVATION</th><th>CHIEF COMPLAINTS</th><th>DIAGNOSIS / PATHOLOGY</th><th>LSMC</th></tr></thead>
      <tbody><tr><td><textarea id="lang_obs" rows="3"></textarea></td><td><textarea id="chief2" rows="3"></textarea></td><td><textarea id="diagnosis" rows="3"></textarea></td><td><textarea id="lsmc" rows="3"></textarea></td></tr></tbody>
    </table>

    <table class="table">
      <thead><tr><th>MIASM / SYPHILIS / PSORIC</th><th>MIND & DISPOSITION</th><th>HISTORIES / AF FACTORS</th><th>SENSATION / SUPERCLASS</th></tr></thead>
      <tbody><tr><td><textarea id="miasm" rows="3"></textarea></td><td><textarea id="mind" rows="3"></textarea></td><td><textarea id="histories" rows="3"></textarea></td><td><textarea id="sensation" rows="3"></textarea></td></tr></tbody>
    </table>

    <h2>3. Physicals & Prescription</h2>
    <label>Physical Generals</label><textarea id="physical" rows="3"></textarea>
    <label>Lab Investigation + Examination (notes)</label><textarea id="invest_notes" rows="2"></textarea>
    <label>Totality</label><textarea id="totality" rows="2"></textarea>
    <label>Repertorial / Non-Repertorial (notes)</label><textarea id="repertorial_notes" rows="2"></textarea>

    <h3>Prescription</h3>
    <table class="table" id="presTable">
      <thead><tr><th>Medicine Name</th><th>Form & ML</th><th>Prescribed Time</th></tr></thead>
      <tbody>
        <tr><td><input class="pres-name"></td><td><input class="pres-form"></td><td><input class="pres-time"></td></tr>
        <tr><td><input class="pres-name"></td><td><input class="pres-form"></td><td><input class="pres-time"></td></tr>
        <tr><td><input class="pres-name"></td><td><input class="pres-form"></td><td><input class="pres-time"></td></tr>
      </tbody>
    </table>
    <div class="toolbar"><button type="button" id="addPres" class="green">Add Prescription Row</button></div>

    <div class="field-row">
      <div><label>Next Follow-up Date</label><input type="date" id="followup_date"></div>
      <div></div>
    </div>

    <div class="toolbar" style="margin-top:12px">
      <button type="button" id="saveBtn" class="green">ðŸ’¾ Save Patient</button>
      <button type="button" id="waReg" class="gray">ðŸ“± Send Registration WhatsApp</button>
      <button type="button" id="printPres" class="gray">ðŸ–¨ Print Prescription (Registration)</button>
      <button type="button" id="exportJSON" class="gray">â¬‡ Export JSON</button>
    </div>
  </form>
  <p class="footer-note small">Data saved in browser IndexedDB. Use View page to edit/delete and to add/edit follow-ups.</p>
</main>
<script src="db.js"></script>
<script>
function collectForm(){
  const p={};
  p.date = document.getElementById('date').value || '';
  p.caseNo = document.getElementById('caseNo').value || ('C'+Date.now());
  p.phone = document.getElementById('phone').value || '';
  p.name = document.getElementById('name').value || '';
  p.age = document.getElementById('age').value || '';
  p.gender = document.getElementById('gender').value || '';
  p.occupation = document.getElementById('occupation').value || '';
  p.address = document.getElementById('address').value || '';
  p.chief = document.getElementById('chief').value || '';
  p.lang_obs = document.getElementById('lang_obs').value || '';
  p.chief2 = document.getElementById('chief2').value || '';
  p.diagnosis = document.getElementById('diagnosis').value || '';
  p.lsmc = document.getElementById('lsmc').value || '';
  p.miasm = document.getElementById('miasm').value || '';
  p.mind = document.getElementById('mind').value || '';
  p.histories = document.getElementById('histories').value || '';
  p.sensation = document.getElementById('sensation').value || '';
  p.physical = document.getElementById('physical').value || '';
  p.invest_notes = document.getElementById('invest_notes').value || '';
  p.totality = document.getElementById('totality').value || '';
  p.repertorial_notes = document.getElementById('repertorial_notes').value || '';
  p.followup_date = document.getElementById('followup_date').value || '';
  p.fee = parseFloat(document.getElementById('fee').value || 0);
  p.prescriptions = [];
  document.querySelectorAll('#presTable tbody tr').forEach(tr=>{
    const name = tr.querySelector('.pres-name').value || '';
    const form = tr.querySelector('.pres-form').value || '';
    const time = tr.querySelector('.pres-time').value || '';
    if(name||form||time) p.prescriptions.push({name,form,time});
  });
  p.followups = p.followups || [];
  return p;
}

document.getElementById('addPres').addEventListener('click', ()=>{
  const tbody=document.querySelector('#presTable tbody'); const tr=document.createElement('tr');
  tr.innerHTML = '<td><input class="pres-name"></td><td><input class="pres-form"></td><td><input class="pres-time"></td>'; tbody.appendChild(tr);
});

document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const p = collectForm();
  try{
    await addOrUpdatePatient(p);
    alert('âœ… Patient saved to IndexedDB.');
    window.location.href = 'view_edit_delete.html';
  }catch(err){ alert('Error saving: '+err); }
});

document.getElementById('waReg').addEventListener('click', ()=>{
  const name = document.getElementById('name').value || 'Patient';
  let phone = document.getElementById('phone').value || '';
  phone = phone.replace(/\D/g,'');
  if(phone.length===10) phone='91'+phone;
  if(!phone){ alert('Please enter a phone number.'); return; }
  const msg = 'Hello ' + name + ', this is a registration message from J N Homeopathy Clinic. Thank you.';
  window.open('https://wa.me/'+phone+'?text='+encodeURIComponent(msg),'_blank');
});

document.getElementById('exportJSON').addEventListener('click', async ()=>{
  const all = await getAllPatients();
  const blob = new Blob([JSON.stringify(all, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'patients_export.json'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('printPres').addEventListener('click', ()=>{
  const p = collectForm();
  openPrintWindow(p, 'Registration');
});

function openPrintWindow(p, type){
  const w = window.open('','_blank');
  let html = '<html><head><title>Prescription - '+(p.caseNo||'')+'</title><style>body{font-family:Arial;padding:20px} .header{font-weight:700;font-size:18px} table{width:100%;border-collapse:collapse} td,th{padding:6px;border:1px solid #ddd}</style></head><body>';
  html += '<div class="header">J N Homoeopathy Clinic - Mylapore | Contact: 9150854083</div><hr/>';
  html += '<h3>'+type+' Prescription</h3>';
  html += '<p><strong>Name:</strong> '+(p.name||'')+' | <strong>Age:</strong> '+(p.age||'')+' | <strong>Gender:</strong> '+(p.gender||'')+' | <strong>Phone:</strong> '+(p.phone||'')+'</p>';
  html += '<p><strong>Date:</strong> '+(p.date||'')+' | <strong>Fee:</strong> â‚¹'+(p.fee||0)+'</p>';
  html += '<h4>Prescription</h4><table><thead><tr><th>Medicine</th><th>Form & ML</th><th>Time</th></tr></thead><tbody>';
  (p.prescriptions||[]).forEach(r=> html += '<tr><td>'+(r.name||'')+'</td><td>'+(r.form||'')+'</td><td>'+(r.time||'')+'</td></tr>');
  html += '</tbody></table>';
  html += '<div style="margin-top:18px">Computer generated prescription. Thank you.</div>';
  html += '</body></html>';
  w.document.write(html); w.document.close(); w.print();
}
</script>
</body></html>
