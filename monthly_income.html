
<!doctype html><html lang="en"><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/><title>Monthly Income</title><link rel="stylesheet" href="style.css"></head><body>
<header><h1>J N HOMEOPATHY CLINIC — Income Report</h1></header>
<main class="container">
  <a class="link" href="index.html">⬅ Back to Menu</a>
  <div style="margin-top:12px">
    <label>From</label><input type="date" id="from" value=""><label>To</label><input type="date" id="to" value=""><div class="toolbar"><button id="run" class="green">Run Report</button><button id="export" class="gray">Export CSV</button></div>
  </div>
  <div id="reportArea" style="margin-top:12px"></div>
</main>
<script src="db.js"></script>
<script>
document.getElementById('from').valueAsDate = new Date(); document.getElementById('to').valueAsDate = new Date();
document.getElementById('run').addEventListener('click', async ()=>{
  const from = document.getElementById('from').value; const to = document.getElementById('to').value; if(!from||!to) return alert('Select dates');
  const all = await getAllPatients(); const rows = [];
  function inRange(d){ return d>=from && d<=to; }
  all.forEach(p=>{ if(inRange(p.date)) rows.push({date:p.date,caseNo:p.caseNo,name:p.name,source:'Registration',fee:parseFloat(p.fee||0)}); (p.followups||[]).forEach(f=>{ if(inRange(f.date)) rows.push({date:f.date,caseNo:p.caseNo,name:p.name,source:'Follow-up',fee:parseFloat(f.fee||0)}); }); });
  const total = rows.reduce((s,r)=>s+(parseFloat(r.fee)||0),0); const area = document.getElementById('reportArea'); area.innerHTML = '<p class="small">Found '+rows.length+' records. Total income: ₹'+total.toFixed(2)+'</p>';
  if(rows.length){ let html = '<table class="table"><thead><tr><th>Date</th><th>Case No</th><th>Name</th><th>Source</th><th>Fee</th></tr></thead><tbody>'; rows.forEach(r=> html += '<tr><td>'+r.date+'</td><td>'+r.caseNo+'</td><td>'+r.name+'</td><td>'+r.source+'</td><td>'+r.fee+'</td></tr>'); html += '</tbody></table>'; area.innerHTML += html; }
  window.lastReport = rows;
});
document.getElementById('export').addEventListener('click', ()=>{ if(!window.lastReport) return alert('Run report first'); const rows = window.lastReport; const keys = Object.keys(rows[0]||{}); const csv = [keys.join(',')].concat(rows.map(r=>keys.map(k=>'"'+String(r[k]||'').replace(/"/g,'""')+'"').join(','))).join('\n'); const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'income_report.csv'; a.click(); URL.revokeObjectURL(url); });
</script>
</body></html>
